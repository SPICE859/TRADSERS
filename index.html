<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AHYAN TRADERS</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap CSS (for layout and styling) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      /* ---------- CSS Variables & Global Styles ---------- */
      :root {
        --primary: #5a67d8;
        --secondary: #4a5568;
        --accent: #38b2ac;
        --light: #f7fafc;
        --white: #ffffff;
        --bg: #eff2f7;
        --transition: 0.3s;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body, html {
        font-family: "Roboto", sans-serif;
        background: var(--bg);
        color: var(--secondary);
      }
      /* ---------- Login Page Styles ---------- */
      #loginPage {
        display: flex;
        height: 100vh;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        align-items: center;
        justify-content: center;
      }
      .login-container {
        background: var(--white);
        border-radius: 10px;
        overflow: hidden;
        width: 90%;
        max-width: 800px;
        display: flex;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      .login-left, .login-right {
        flex: 1;
        position: relative;
      }
      .login-left {
        display: none;
      }
      .login-left img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .login-right {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
      }
      .login-box {
        width: 100%;
      }
      .login-box h1 {
        margin-bottom: 20px;
        font-size: 32px;
        color: var(--primary);
        text-align: center;
      }
      .login-box form {
        display: flex;
        flex-direction: column;
      }
      .login-box input[type="text"],
      .login-box input[type="password"] {
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        transition: border var(--transition);
      }
      .login-box input:focus {
        border-color: var(--primary);
        outline: none;
      }
      .login-box button {
        padding: 12px;
        background: var(--primary);
        color: var(--white);
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background var(--transition);
      }
      .login-box button:hover {
        background: var(--accent);
      }
      @media (min-width: 768px) {
        .login-left {
          display: block;
        }
      }
      /* ---------- Dashboard Styles ---------- */
      #dashboard {
        display: none;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 220px;
        height: 100%;
        background: var(--secondary);
        color: var(--white);
        padding: 20px;
        overflow-y: auto;
        box-shadow: 2px 0 5px rgba(0,0,0,0.15);
      }
      .sidebar h2 {
        text-align: center;
        margin-bottom: 30px;
        font-weight: 700;
        font-size: 24px;
      }
      /* Removed "Add New Item" button from sidebar */
      .sidebar button {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 10px;
        border: none;
        background: var(--primary);
        color: var(--white);
        font-size: 16px;
        cursor: pointer;
        border-radius: 4px;
        transition: background var(--transition);
      }
      .sidebar button:hover {
        background: var(--accent);
      }
      .main-content {
        margin-left: 240px;
        padding: 20px;
      }
      .section {
        display: none;
        background: var(--white);
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }
      .header-large {
        text-align: center;
        padding: 15px;
        background: var(--primary);
        color: var(--white);
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 28px;
        font-weight: 500;
      }
      /* ---------- Overview Section ---------- */
      #overviewHeader {
        background: var(--white);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        border-radius: 4px;
      }
      #overviewHeader h2 {
        margin: 0;
        color: var(--primary);
      }
      .overview-cards .card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        transition: transform var(--transition);
      }
      .overview-cards .card:hover {
        transform: translateY(-5px);
      }
      .overview-cards .card h5 {
        font-weight: 600;
      }
      /* ---------- View Products Section ---------- */
      #viewProducts {
        display: none;
        background: var(--white);
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }
      #viewProducts h2 {
        color: var(--primary);
        margin-bottom: 20px;
        text-align: center;
      }
      #viewProducts ul {
        list-style: none;
        padding-left: 0;
      }
      #viewProducts li {
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }
      /* ---------- Modal Styles ---------- */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: var(--white);
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 400px;
      }
      .modal h3 {
        margin-top: 0;
        color: var(--primary);
      }
      .modal input,
      .modal select {
        width: 100%;
        padding: 8px;
        margin: 5px 0 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        transition: border var(--transition);
      }
      .modal input:focus,
      .modal select:focus {
        border-color: var(--primary);
        outline: none;
      }
      .modal button {
        margin-top: 10px;
        padding: 10px 14px;
        background: var(--primary);
        color: var(--white);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background var(--transition);
      }
      .modal button:hover {
        background: var(--accent);
      }
      @media print {
        body { color: black; background: white; }
        .no-print { display: none; }
        table, th, td { border: 1px solid black; }
        td:empty::after { content: "0.00"; }
      }
    </style>
  </head>
  <body>
    <!-- ---------- Login Section ---------- -->
    <div id="loginPage">
      <div class="login-container">
        <!-- Slideshow (Left) -->
        <div class="login-left">
          <img
            id="slideshow"
            src="https://raw.githubusercontent.com/SPICE859/pictures/refs/heads/main/3.png"
            alt="Slideshow Image"
          />
        </div>
        <!-- Login Form (Right) -->
        <div class="login-right">
          <div class="login-box">
            <h1>AHYAN TRADERS</h1>
            <form id="loginForm">
              <input type="text" id="username" placeholder="Username" required />
              <input type="password" id="password" placeholder="Password" required />
              <button type="submit">Login</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ---------- Dashboard Section ---------- -->
    <div id="dashboard">
      <!-- Sidebar -->
      <div class="sidebar">
        <h2>AHYAN TRADERS</h2>
        <button onclick="showSection('overview')">Overview</button>
        <button onclick="showSection('saleSummary')">Sale Summary</button>
        <button onclick="showSection('stockReport')">Stock Report</button>
        <!-- "Add New Item" button removed -->
        <button onclick="showSection('viewSavedItemsSection')">View Saved Items</button>
        <button onclick="showSection('viewProducts')">View Products</button>
        <button onclick="window.location.href='billing.html'">Billing System</button>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Overview Section (New Interactive Dashboard) -->
        <div id="overview" class="section">
          <div id="overviewHeader">
            <h2>Dashboard Overview</h2>
            <!-- Removed search bar -->
            <div>
              <button class="btn btn-primary" onclick="logout()">Logout</button>
            </div>
          </div>
          <!-- Overview Cards -->
          <div class="row overview-cards">
            <div class="col-lg-4 col-md-6 mb-3">
              <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <h5 class="card-title">Total Sales</h5>
                    <h3>Rs. 35,000</h3>
                  </div>
                  <i class="bi bi-currency-dollar fs-1 text-success"></i>
                </div>
                <!-- Navigates to Sale Summary page -->
                <button class="btn btn-sm btn-outline-primary" onclick="showSection('saleSummary')">View Sale Details</button>
              </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-3">
              <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <h5 class="card-title">Stocks</h5>
                    <h3>120</h3>
                  </div>
                  <i class="bi bi-box-seam fs-1 text-primary"></i>
                </div>
                <!-- Navigates to Stock Report page -->
                <button class="btn btn-sm btn-outline-primary" onclick="showSection('stockReport')">Manage Stocks</button>
              </div>
            </div>
            <div class="col-lg-4 col-md-12 mb-3">
              <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <h5 class="card-title">Products</h5>
                    <h3>8</h3>
                  </div>
                  <i class="bi bi-card-list fs-1 text-warning"></i>
                </div>
                <!-- Navigates to the View Products page -->
                <button class="btn btn-sm btn-outline-primary" onclick="showSection('viewProducts')">View Products</button>
              </div>
            </div>
          </div>
          <!-- Overview Chart -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card p-4">
                <h5 class="card-title mb-3">Sales Analytics</h5>
                <canvas id="overviewChart" height="100"></canvas>
                <button class="btn btn-sm btn-outline-secondary mt-3" id="updateChart">Update Chart</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Sale Summary Section -->
        <div id="saleSummary" class="section">
          <div class="header-large">Sale Summary</div>
          <div class="filter-container mb-3">
            <label for="startDate">Initial Date:</label>
            <input type="date" id="startDate" class="form-control d-inline-block" style="width: 180px;" />
            <label for="endDate" class="ms-2">Current Date:</label>
            <input type="date" id="endDate" class="form-control d-inline-block" style="width: 180px;" />
            <button class="btn btn-primary ms-2" onclick="filterSales()">Filter</button>
          </div>
          <table class="table table-striped table-hover">
            <thead class="table-primary">
              <tr>
                <th>Date</th>
                <th>Invoice No</th>
                <th>Customer</th>
                <th>Net Amount (Rs.)</th>
              </tr>
            </thead>
            <tbody id="salesTableBody">
              <!-- Billing data will be inserted here -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" class="text-end fw-bold">Net Total Sale (Rs.):</td>
                <td id="netTotal" class="fw-bold">Rs. 0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Stock Report Section -->
        <div id="stockReport" class="section">
          <div class="header-large">Stock Report</div>
          <div class="search-container mb-3">
            <input type="text" id="stockSearchInput" class="form-control" placeholder="Search by Product Name, CTN Size..." />
          </div>
          <div class="text-center mb-3">
            <button class="btn btn-primary me-2" onclick="openAddStockModal()">Add New Stock</button>
            <button class="btn btn-secondary" onclick="openUpdateSaleModal()">Update Sale</button>
          </div>
          <table class="table table-bordered table-hover">
            <thead class="table-primary">
              <tr>
                <th>Product Name</th>
                <th>CTN Size</th>
                <th>Available CTNs</th>
                <th>Available Boxes</th>
                <th>Unit Price (Rs.)</th>
                <th>Total Value (Rs.)</th>
              </tr>
            </thead>
            <tbody id="stockTableBody">
              <!-- Aggregated stock and sale data will appear here -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="text-end fw-bold">Net Total Stock Value (Rs.):</td>
                <td id="netStockValue" class="fw-bold">Rs. 0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- View Saved Items Section -->
        <div id="viewSavedItemsSection" class="section">
          <div class="header-large">View Saved Items</div>
          <div class="container">
            <div class="search-container mb-3">
              <input type="text" id="viewSavedSearch" class="form-control" placeholder="Search items..." oninput="filterViewSavedItems()" />
            </div>
            <table class="table table-bordered table-hover">
              <thead class="table-primary">
                <tr>
                  <th>Product ID</th>
                  <th>Description</th>
                  <th>CTN Size</th>
                  <th>Boxes per CTN</th>
                  <th>CTN Price</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="savedItemsTableBody">
                <!-- Saved items will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- View Products Section -->
        <div id="viewProducts" class="section">
          <h2 class="text-center mb-4" style="color: var(--primary);">View Products</h2>
          <ul id="viewProductsList" class="list-group">
            <!-- Product list items will be populated here -->
          </ul>
        </div>
      </div>

      <!-- ---------- Modals ---------- -->
      <!-- Edit Item Modal -->
      <div id="editItemModal" class="modal no-print">
        <h3>Edit Item</h3>
        <input type="hidden" id="editItemId" />
        <label for="editDescription">Description:</label>
        <input type="text" id="editDescription" />
        <label for="editCtnSize">CTN Size:</label>
        <input type="text" id="editCtnSize" />
        <label for="editCtnPrice">CTN Price:</label>
        <input type="number" id="editCtnPrice" />
        <label for="editBoxesPerCtn">Boxes per CTN:</label>
        <input type="number" id="editBoxesPerCtn" />
        <button class="btn btn-primary" onclick="saveEditedItem()">Save Changes</button>
        <button class="btn btn-secondary" onclick="closeModal('editItemModal')">Close</button>
      </div>

      <!-- Add New Stock Modal -->
      <div id="addStockModal" class="modal no-print">
        <h3>Add New Stock</h3>
        <label for="stockItemSelect">Select Item:</label>
        <select id="stockItemSelect" class="form-select"></select>
        <label>Add Qty:</label>
        <div class="mb-2">
          <label for="stockCtns">CTNs:</label>
          <input type="number" id="stockCtns" class="form-control" placeholder="0" value="0" />
        </div>
        <div class="mb-2">
          <label for="stockBoxes">Boxes:</label>
          <input type="number" id="stockBoxes" class="form-control" placeholder="0" value="0" />
        </div>
        <button class="btn btn-primary" onclick="saveNewStock()">Save Stock</button>
        <button class="btn btn-secondary" onclick="closeModal('addStockModal')">Close</button>
      </div>

      <!-- Update Sale Modal -->
      <div id="updateSaleModal" class="modal no-print">
        <h3>Update Sale</h3>
        <label for="saleItemSelect">Select Item:</label>
        <select id="saleItemSelect" class="form-select"></select>
        <label>Sale Qty:</label>
        <div class="mb-2">
          <label for="saleCtns">CTNs:</label>
          <input type="number" id="saleCtns" class="form-control" placeholder="0" value="0" />
        </div>
        <div class="mb-2">
          <label for="saleBoxes">Boxes:</label>
          <input type="number" id="saleBoxes" class="form-control" placeholder="0" value="0" />
        </div>
        <button class="btn btn-primary" onclick="saveSale()">Save Sale</button>
        <button class="btn btn-secondary" onclick="closeModal('updateSaleModal')">Close</button>
      </div>
    </div>

    <!-- ---------- Scripts ---------- -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // If already logged in, show dashboard; otherwise, show login
      if (sessionStorage.getItem("loggedIn") === "true") {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
      }
      
      // Slideshow for Login Page
      const images = [
        "https://raw.githubusercontent.com/SPICE859/pictures/refs/heads/main/3.png",
        "https://raw.githubusercontent.com/SPICE859/pictures/refs/heads/main/2.png",
        "https://raw.githubusercontent.com/SPICE859/pictures/refs/heads/main/4.png",
        "https://raw.githubusercontent.com/SPICE859/pictures/refs/heads/main/5.png",
        "https://raw.githubusercontent.com/SPICE859/pictures/refs/heads/main/7.png"
      ];
      let currentIndex = 0;
      const slideshowImage = document.getElementById("slideshow");
      function nextImage() {
        currentIndex = (currentIndex + 1) % images.length;
        slideshowImage.style.opacity = 0;
        setTimeout(() => {
          slideshowImage.src = images[currentIndex];
          slideshowImage.style.opacity = 1;
        }, 300);
      }
      setInterval(nextImage, 3000);
      
      // Login Form Submission
      document.getElementById("loginForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        if (username === "admin" && password === "admin") {
          sessionStorage.setItem("loggedIn", "true");
          document.getElementById("loginPage").style.display = "none";
          document.getElementById("dashboard").style.display = "block";
        } else {
          alert("Invalid credentials. Please try again.");
        }
      });
      
      // Firebase Initialization
      const firebaseConfig = {
        apiKey: "AIzaSyD_ojS20opjpxmwHxIHATC52ncABe_fkuk",
        authDomain: "ahyan-traders.firebaseapp.com",
        projectId: "ahyan-traders",
        storageBucket: "ahyan-traders.firebasestorage.app",
        messagingSenderId: "1024047266496",
        appId: "1:1024047266496:web:349c052d55564a96bfcb25",
        measurementId: "G-11ZNXV1ZZL"
      };
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
      const db = firebase.firestore();
      
      // Custom Firestore and Modal Functions
      
      async function getSavedItems() {
        const itemsSnapshot = await db.collection("items").get();
        const itemsMap = {};
        itemsSnapshot.forEach((doc) => {
          const data = doc.data();
          itemsMap[doc.id] = {
            code: data.code || "",
            description: data.description || "",
            ctnSize: data.ctnSize || "",
            boxesPerCtn: data.boxesPerCtn || 0,
            ctnPrice: data.ctnPrice || 0
          };
        });
        return itemsMap;
      }
      
      // "Add New Item" functionality has been removed.
      
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }
      
      async function updateSavedItemsTable() {
        try {
          const itemsMap = await getSavedItems();
          const tbody = document.getElementById("savedItemsTableBody");
          tbody.innerHTML = "";
          for (const id in itemsMap) {
            const item = itemsMap[id];
            let row = document.createElement("tr");
            row.innerHTML = `
              <td>${id}</td>
              <td>${item.description}</td>
              <td>${item.ctnSize}</td>
              <td>${item.boxesPerCtn}</td>
              <td>Rs. ${parseFloat(item.ctnPrice).toFixed(2)}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${id}')">Edit</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${id}')">Delete</button>
              </td>
            `;
            tbody.appendChild(row);
          }
        } catch (error) {
          console.error("Error fetching saved items:", error);
        }
      }
      
      async function updateStockReportTable() {
        try {
          const stockSnapshot = await db.collection("stock").get();
          const stockAggregation = {};
          stockSnapshot.forEach((doc) => {
            const productName = doc.id;
            stockAggregation[productName] = doc.data();
          });
          const saleSnapshot = await db.collection("sales").get();
          const saleAggregation = {};
          saleSnapshot.forEach((doc) => {
            const productName = doc.id;
            saleAggregation[productName] = doc.data();
          });
          const itemsMap = await getSavedItems();
          const tbody = document.getElementById("stockTableBody");
          tbody.innerHTML = "";
          let netStockValue = 0;
          const filter = (document.getElementById("stockSearchInput").value || "").toUpperCase();
          for (const productName in stockAggregation) {
            if (productName.toUpperCase().indexOf(filter) > -1) {
              const stockData = stockAggregation[productName] || { ctns: 0, boxes: 0, pcs: 0 };
              const saleData = saleAggregation[productName] || { ctns: 0, boxes: 0, pcs: 0 };
              const netCTNs = stockData.ctns - saleData.ctns;
              const netBoxes = stockData.boxes - saleData.boxes;
              let itemDetails = null;
              for (const key in itemsMap) {
                if (itemsMap[key].description === productName) {
                  itemDetails = itemsMap[key];
                  break;
                }
              }
              if (!itemDetails) continue;
              const unitPrice = parseFloat(itemDetails.ctnPrice);
              const totalValueForItem =
                netCTNs * unitPrice + ((netBoxes / itemDetails.boxesPerCtn) * unitPrice);
              netStockValue += totalValueForItem;
              let row = `<tr>
                  <td>${productName}</td>
                  <td>${itemDetails.ctnSize}</td>
                  <td>${netCTNs}</td>
                  <td>${netBoxes}</td>
                  <td>Rs. ${unitPrice.toFixed(2)}</td>
                  <td>Rs. ${totalValueForItem.toFixed(2)}</td>
              </tr>`;
              tbody.innerHTML += row;
            }
          }
          if (tbody.innerHTML === "") {
            tbody.innerHTML = "<tr><td colspan='6'>No data available</td></tr>";
          }
          document.getElementById("netStockValue").textContent =
            "Rs. " + netStockValue.toFixed(2);
        } catch (error) {
          console.error("Error fetching stock, sales or saved items:", error);
        }
      }
      
      async function deleteItem(itemId) {
        try {
          await db.collection("items").doc(itemId).delete();
          alert("Item deleted successfully");
          updateSavedItemsTable();
          updateStockReportTable();
        } catch (error) {
          console.error("Error deleting item:", error);
          alert("Error deleting item.");
        }
      }
      
      async function openEditModal(itemId) {
        try {
          const docRef = db.collection("items").doc(itemId);
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            const item = docSnap.data();
            document.getElementById("editItemId").value = itemId;
            document.getElementById("editDescription").value = item.description;
            document.getElementById("editCtnSize").value = item.ctnSize;
            document.getElementById("editCtnPrice").value = item.ctnPrice;
            document.getElementById("editBoxesPerCtn").value = item.boxesPerCtn;
            document.getElementById("editItemModal").style.display = "block";
          }
        } catch (error) {
          console.error("Error opening edit modal:", error);
        }
      }
      
      async function saveEditedItem() {
        const itemId = document.getElementById("editItemId").value;
        const desc = document.getElementById("editDescription").value.trim();
        const size = document.getElementById("editCtnSize").value.trim();
        const price = parseFloat(document.getElementById("editCtnPrice").value);
        const boxes = parseFloat(document.getElementById("editBoxesPerCtn").value);
        if (desc && size && !isNaN(price) && !isNaN(boxes)) {
          try {
            await db.collection("items").doc(itemId).update({
              description: desc,
              ctnSize: size,
              ctnPrice: price,
              boxesPerCtn: boxes
            });
            alert("Item updated successfully!");
            closeModal("editItemModal");
            updateSavedItemsTable();
            updateStockReportTable();
          } catch (error) {
            console.error("Error updating item:", error);
            alert("Error updating item.");
          }
        } else {
          alert("Please fill in all fields correctly.");
        }
      }
      
      async function updateSaleSummaryTable() {
        try {
          const querySnapshot = await db.collection("billing").get();
          const tbody = document.getElementById("salesTableBody");
          tbody.innerHTML = "";
          let total = 0;
          querySnapshot.forEach((doc) => {
            const bill = doc.data();
            let netAmount = parseFloat(bill.netAmount);
            total += netAmount;
            let dateStr = "N/A";
            if (bill.billDate) {
              let date = new Date(bill.billDate);
              let month = (date.getMonth() + 1).toString().padStart(2, "0");
              let day = date.getDate().toString().padStart(2, "0");
              let year = date.getFullYear();
              dateStr = `${month}/${day}/${year}`;
            }
            let row = `<tr>
              <td>${dateStr}</td>
              <td>${bill.invoiceNo || ""}</td>
              <td>${bill.customer || ""}</td>
              <td>Rs. ${netAmount.toFixed(2)}</td>
            </tr>`;
            tbody.innerHTML += row;
          });
          document.getElementById("netTotal").textContent =
            "Rs. " + total.toFixed(2);
        } catch (error) {
          console.error("Error fetching billing data:", error);
        }
      }
      
      function filterSales() {
        var startDate = document.getElementById("startDate").value;
        var endDate = document.getElementById("endDate").value;
        var tbody = document.getElementById("salesTableBody");
        var rows = tbody.getElementsByTagName("tr");
        var total = 0;
        for (var i = 0; i < rows.length; i++) {
          var dateText = rows[i].getElementsByTagName("td")[0].textContent;
          var showRow = true;
          if (startDate && dateText < startDate) { showRow = false; }
          if (endDate && dateText > endDate) { showRow = false; }
          if (showRow) {
            rows[i].style.display = "";
            var amountText = rows[i].getElementsByTagName("td")[3].textContent.trim();
            var netAmount = parseFloat(amountText.replace("Rs.", "").trim());
            if (!isNaN(netAmount)) { total += netAmount; }
          } else { rows[i].style.display = "none"; }
        }
        document.getElementById("netTotal").textContent = "Rs. " + total.toFixed(2);
      }
      
      function filterViewSavedItems() {
        let filter = (document.getElementById("viewSavedSearch").value || "").toUpperCase();
        let table = document.getElementById("savedItemsTable");
        let trs = table.getElementsByTagName("tr");
        for (let i = 1; i < trs.length; i++) {
          let tds = trs[i].getElementsByTagName("td");
          let show = false;
          for (let j = 0; j < tds.length - 1; j++) {
            if ((tds[j].textContent || "").toUpperCase().indexOf(filter) > -1) {
              show = true;
              break;
            }
          }
          trs[i].style.display = show ? "" : "none";
        }
      }
      
      function openAddStockModal() {
        document.getElementById("addStockModal").style.display = "block";
        populateStockItemSelect();
      }
      
      async function populateStockItemSelect() {
        try {
          const itemsMap = await getSavedItems();
          const select = document.getElementById("stockItemSelect");
          select.innerHTML = "<option value=''>Select an item</option>";
          for (const id in itemsMap) {
            const item = itemsMap[id];
            select.innerHTML += `<option value="${id}">${item.code} - ${item.description}</option>`;
          }
        } catch (error) {
          console.error("Error populating stock items:", error);
        }
      }
      
      async function saveNewStock() {
        const itemId = document.getElementById("stockItemSelect").value;
        const ctns = parseInt(document.getElementById("stockCtns").value) || 0;
        const boxes = parseInt(document.getElementById("stockBoxes").value) || 0;
        if (!itemId) { alert("Please select an item."); return; }
        const itemsMap = await getSavedItems();
        const selectedItem = itemsMap[itemId];
        if (!selectedItem) { alert("Invalid item selected."); return; }
        const productName = selectedItem.description;
        const stockRef = db.collection("stock").doc(productName);
        try {
          const docSnap = await stockRef.get();
          if (docSnap.exists) {
            await stockRef.update({
              ctns: firebase.firestore.FieldValue.increment(ctns),
              boxes: firebase.firestore.FieldValue.increment(boxes)
            });
          } else {
            await stockRef.set({ ctns, boxes, pcs: 0 });
          }
          alert("Stock added successfully!");
          document.getElementById("stockCtns").value = "0";
          document.getElementById("stockBoxes").value = "0";
          closeModal("addStockModal");
          updateStockReportTable();
        } catch (error) {
          console.error("Error adding stock:", error);
          alert("Error adding stock.");
        }
      }
      
      async function saveSale() {
        const itemId = document.getElementById("saleItemSelect").value;
        const ctns = parseInt(document.getElementById("saleCtns").value) || 0;
        const boxes = parseInt(document.getElementById("saleBoxes").value) || 0;
        if (!itemId) { alert("Please select an item."); return; }
        const itemsMap = await getSavedItems();
        const selectedItem = itemsMap[itemId];
        if (!selectedItem) { alert("Invalid item selected."); return; }
        const productName = selectedItem.description;
        const saleRef = db.collection("sales").doc(productName);
        try {
          const docSnap = await saleRef.get();
          if (docSnap.exists) {
            await saleRef.update({
              ctns: firebase.firestore.FieldValue.increment(ctns),
              boxes: firebase.firestore.FieldValue.increment(boxes)
            });
          } else {
            await saleRef.set({
              ctns, boxes, pcs: 0,
              date: new Date().toISOString()
            });
          }
          alert("Sale updated successfully!");
          document.getElementById("saleCtns").value = "0";
          document.getElementById("saleBoxes").value = "0";
          closeModal("updateSaleModal");
          updateStockReportTable();
        } catch (error) {
          console.error("Error updating sale:", error);
          alert("Error updating sale.");
        }
      }
      
      function openUpdateSaleModal() {
        document.getElementById("updateSaleModal").style.display = "block";
        populateSaleItemSelect();
      }
      
      async function populateSaleItemSelect() {
        try {
          const itemsMap = await getSavedItems();
          const select = document.getElementById("saleItemSelect");
          select.innerHTML = "<option value=''>Select an item</option>";
          for (const id in itemsMap) {
            const item = itemsMap[id];
            select.innerHTML += `<option value="${id}">${item.code} - ${item.description}</option>`;
          }
        } catch (error) {
          console.error("Error populating sale items:", error);
        }
      }
      
      function showSection(sectionId) {
        const sections = document.getElementsByClassName("section");
        for (let i = 0; i < sections.length; i++) {
          sections[i].style.display = "none";
        }
        document.getElementById(sectionId).style.display = "block";
        if (sectionId === "saleSummary") { updateSaleSummaryTable(); }
        if (sectionId === "stockReport") { updateStockReportTable(); }
        if (sectionId === "viewSavedItemsSection") { updateSavedItemsTable(); }
        if (sectionId === "overview") {
          if (!window.overviewChart) { initOverviewChart(); }
        }
        if (sectionId === "viewProducts") {
          updateViewProducts();
        }
      }
      
      // New function: updateViewProducts populates the View Products section
      async function updateViewProducts() {
        try {
          const itemsMap = await getSavedItems();
          const ul = document.getElementById("viewProductsList");
          ul.innerHTML = "";
          for (const id in itemsMap) {
            const item = itemsMap[id];
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.textContent = item.code + " - " + item.description;
            ul.appendChild(li);
          }
          if (ul.innerHTML === "") {
            ul.innerHTML = "<li class='list-group-item'>No products available</li>";
          }
        } catch (error) {
          console.error("Error fetching products:", error);
        }
      }
      
      // Initialize the Overview Chart using Chart.js with dynamic data from billing collection
      async function updateOverviewChart() {
        try {
          const querySnapshot = await db.collection("billing").get();
          const monthlySales = {};
          // Aggregate net sales by month from billing data
          querySnapshot.forEach((doc) => {
            const bill = doc.data();
            if (bill.billDate && bill.netAmount) {
              let date = new Date(bill.billDate);
              // Get month in short format (e.g., Jan, Feb)
              let month = date.toLocaleString("default", { month: "short" });
              if (!monthlySales[month]) {
                monthlySales[month] = 0;
              }
              monthlySales[month] += parseFloat(bill.netAmount);
            }
          });
          // Sort months in calendar order
          const allMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
          const labels = allMonths.filter((m) => monthlySales[m] !== undefined);
          const data = labels.map((m) => monthlySales[m]);
          if (window.overviewChart) {
            window.overviewChart.data.labels = labels;
            window.overviewChart.data.datasets[0].data = data;
            window.overviewChart.update();
          }
        } catch (error) {
          console.error("Error updating overview chart:", error);
        }
      }
      
      // Initialize the chart initially with dynamic data
      function initOverviewChart() {
        const ctx = document.getElementById("overviewChart").getContext("2d");
        window.overviewChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [{
              label: "Sales in Rs.",
              data: [],
              borderColor: "rgba(75,192,192,1)",
              backgroundColor: "rgba(75,192,192,0.2)",
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } }
          }
        });
        updateOverviewChart();
      }
      
      document.getElementById("updateChart")?.addEventListener("click", () => {
        updateOverviewChart();
      });
      
      // Custom logout function
      function logout() {
        sessionStorage.removeItem("loggedIn");
        location.reload();
      }
      
      function attachGlobals() {
        window.closeModal = closeModal;
        window.updateSavedItemsTable = updateSavedItemsTable;
        window.updateStockReportTable = updateStockReportTable;
        window.deleteItem = deleteItem;
        window.openEditModal = openEditModal;
        window.saveEditedItem = saveEditedItem;
        window.filterSales = filterSales;
        window.filterViewSavedItems = filterViewSavedItems;
        window.showSection = showSection;
        window.openAddStockModal = openAddStockModal;
        window.saveNewStock = saveNewStock;
        window.openUpdateSaleModal = openUpdateSaleModal;
        window.saveSale = saveSale;
        window.updateSaleSummaryTable = updateSaleSummaryTable;
        window.logout = logout;
        console.log("Global functions attached");
      }
      
      attachGlobals();
      // Start by showing the Overview section
      showSection("overview");
      document.getElementById("stockSearchInput").addEventListener("input", updateStockReportTable);
      document.addEventListener("DOMContentLoaded", () => {
        initOverviewChart();
      });
    </script>
  </body>
</html>
